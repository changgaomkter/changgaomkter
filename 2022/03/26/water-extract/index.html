<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Water_Extracting | Dreaming</title><meta name="keywords" content="Study,Python,Pytorch,AI,CV"><meta name="author" content="Yuhang Chen"><meta name="copyright" content="Yuhang Chen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="My graduation project--- A Deep Learning Semantic Segmentation Algorithms">
<meta property="og:type" content="article">
<meta property="og:title" content="Water_Extracting">
<meta property="og:url" content="http://waterkingest.gitee.io/2022/03/26/water-extract/index.html">
<meta property="og:site_name" content="Dreaming">
<meta property="og:description" content="My graduation project--- A Deep Learning Semantic Segmentation Algorithms">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/20220326/pytorch.5sb4sp2wouc0.webp">
<meta property="article:published_time" content="2022-03-26T21:42:42.000Z">
<meta property="article:modified_time" content="2023-06-29T07:06:16.269Z">
<meta property="article:author" content="Yuhang Chen">
<meta property="article:tag" content="Study">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Pytorch">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="CV">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/20220326/pytorch.5sb4sp2wouc0.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://waterkingest.gitee.io/2022/03/26/water-extract/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6e088103de54a760ddaa12b65dea0898";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":100},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Yuhang Chen","link":"Link: ","source":"Source: Dreaming","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Water_Extracting',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-29 03:06:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_3261664_6l4hj6o85xj.css"><meta name="baidu-site-verification" content="code-unKEYLRHwi" /><script type="text/javascript" src='/js/skiphttps.js'></script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">28</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></div><div class="menus_item"><a class="site-page" href="/secret/"><i class="fa-fw fas fa-candy-cane"></i><span> Secret Garden</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/20220326/pytorch.5sb4sp2wouc0.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Dreaming</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></div><div class="menus_item"><a class="site-page" href="/secret/"><i class="fa-fw fas fa-candy-cane"></i><span> Secret Garden</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Water_Extracting</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-26T21:42:42.000Z" title="Created 2022-03-26 17:42:42">2022-03-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-06-29T07:06:16.269Z" title="Updated 2023-06-29 03:06:16">2023-06-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Project/">Project</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">1.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>8min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Water_Extracting"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/2022/03/26/water-extract/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2022/03/26/water-extract/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>In this project, I design a neural network structure to achieve the
target of extracting water body from the remote sensing images. And
finally it achive a better result than other previously methods.</p>
<h2 id="target">Target</h2>
<p>In urban features, water bodies influence the functioning of urban
ecosystems in various ways, with their role in, for example, tourism,
flood control and urban heat island regulation constantly influencing
human life and urban economic development. There for a objective and
accurate understanding of the spatial and temporal distribution
characteristics of urban water resources is essential for urban planning
and development. To achieve this target, designing an effective and
reliable method to help human to extract this data from remote sensing
images more quicklly is useful and necessary. In this situation,
designing an artificial inteligent method to achieve this goal base on
deep learning is suitable.</p>
<hr />
<h2 id="method">Method</h2>
<h3 id="data-processing">Data processing</h3>
<p>First of all, we need to get the data that is used to train the deep
learining algorithms. I choose download the remote sensing images of
Chengdu, China from the Google Earth Engine. I have acquired almost 40
images of 4000*4000. Then I use the ArcMap to make the lable of each
image, to creat the data of training.<br />
<img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.3kagxm78k0e0.webp"
alt="image" /><br />
<img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.5sgq2nnhxdg.webp"
alt="label" /></p>
<p>To enhance the robustness and generalisation of the network, it is
often necessary to augment the training data. In this project, the
existing dataset was randomly transformed by mirroring, vertical
transformation, cropping, random selection, fuzzy processing and noise
addition operations, eventually expanding the dataset to 10000 images of
512*512. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>	<span class="title">gamma_transform</span>(<span class="params">img, gamma</span>):</span></span><br><span class="line">    gamma_table = [np.power(x / <span class="number">255.0</span>, gamma) * <span class="number">255.0</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">    gamma_table = np.<span class="built_in">round</span>(np.array(gamma_table)).astype(np.uint8)</span><br><span class="line">    <span class="keyword">return</span> cv2.LUT(img, gamma_table)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_gamma_transform</span>(<span class="params">img, gamma_vari</span>):</span></span><br><span class="line">    log_gamma_vari = np.log(gamma_vari)</span><br><span class="line">    alpha = np.random.uniform(-log_gamma_vari, log_gamma_vari)</span><br><span class="line">    gamma = np.exp(alpha)</span><br><span class="line">    <span class="keyword">return</span> gamma_transform(img, gamma)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rotate</span>(<span class="params">xb,yb,angle,img_w,img_h</span>):</span></span><br><span class="line">    M_rotate = cv2.getRotationMatrix2D((img_w/<span class="number">2</span>, img_h/<span class="number">2</span>), angle, <span class="number">1</span>)</span><br><span class="line">    xb = cv2.warpAffine(xb, M_rotate, (img_w, img_h))</span><br><span class="line">    yb = cv2.warpAffine(yb, M_rotate, (img_w, img_h))</span><br><span class="line">    <span class="keyword">return</span> xb,yb</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blur</span>(<span class="params">img</span>):</span><span class="comment">#加模糊</span></span><br><span class="line">    img = cv2.blur(img, (<span class="number">3</span>, <span class="number">3</span>));</span><br><span class="line">    <span class="keyword">return</span> img</span><br></pre></td></tr></table></figure> The final result is as follows.<br />
<img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.6cg7zzrd5400.webp"
alt="image" /> <img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.55jm84moiv80.webp"
alt="label" /></p>
<h3 id="network-structure">Network structure</h3>
<p>In this projcet, I improve the traditional Unet structure, like the
image shows below. <img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/UNET.3jdhghg3kew0.webp"
alt="UNET" /> A deeper network structure is designed based on Unet,
while Dilated convolution is used to implement feature map downsampling
and feature extraction to further improve the accuracy and
generalisation of the network extraction. Meanwhile, I introduce the
Res-block that is a good solution to the problem of network degradation
that can occur when the network structure is too deep. <img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/Resunet.5kql22bye9o0.webp"
alt="Resunet" /> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, num_classes=<span class="number">2</span>, in_channels=<span class="number">3</span>, pretrained=<span class="literal">False</span>,record=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(MyUnet2, self).__init__()</span><br><span class="line">        out_filters = [<span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>,<span class="number">1024</span>]</span><br><span class="line">        resnet = models.resnet34(pretrained=<span class="literal">True</span>)</span><br><span class="line">        self.record=record</span><br><span class="line">        self.encoder1 = resnet.layer1</span><br><span class="line">        self.encodecov1=nn.Sequential(</span><br><span class="line">                nn.Conv2d(out_filters[<span class="number">0</span>],out_filters[<span class="number">1</span>], kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">                nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">                nn.BatchNorm2d(out_filters[<span class="number">1</span>]),</span><br><span class="line">            )</span><br><span class="line">        self.encoder2 = resnet.layer2</span><br><span class="line">        self.encodecov2=nn.Sequential(</span><br><span class="line">                nn.Conv2d(out_filters[<span class="number">1</span>],out_filters[<span class="number">2</span>], kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">                nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">                nn.BatchNorm2d(out_filters[<span class="number">2</span>]),</span><br><span class="line">            )</span><br><span class="line">        self.encoder3 = resnet.layer3</span><br><span class="line">        self.encodecov3=nn.Sequential(</span><br><span class="line">                nn.Conv2d(out_filters[<span class="number">2</span>],out_filters[<span class="number">3</span>], kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">                nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">                nn.BatchNorm2d(out_filters[<span class="number">3</span>]),</span><br><span class="line">            )</span><br><span class="line">        self.encoder4 = resnet.layer4</span><br><span class="line">        self.encodecov4=nn.Conv2d(out_filters[<span class="number">3</span>],out_filters[<span class="number">4</span>],kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)</span><br><span class="line">        self.Down1 = unetDown(in_channels, out_filters[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        self.Down2 = unetDown(out_filters[<span class="number">0</span>], out_filters[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        self.Down3 = unetDown(out_filters[<span class="number">1</span>], out_filters[<span class="number">2</span>])</span><br><span class="line">        </span><br><span class="line">        self.Down4 = unetDown2(out_filters[<span class="number">2</span>], out_filters[<span class="number">3</span>])</span><br><span class="line">        </span><br><span class="line">        self.Down5 = unetDown3(out_filters[<span class="number">3</span>], out_filters[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">        self.Up1=unetUp(out_filters[<span class="number">4</span>], out_filters[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">        self.Up2=unetUp(out_filters[<span class="number">3</span>], out_filters[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        self.Up3=unetUp(out_filters[<span class="number">2</span>], out_filters[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        self.Up4=unetUp(out_filters[<span class="number">1</span>], out_filters[<span class="number">0</span>])</span><br><span class="line">        self.cov111=nn.Conv2d(out_filters[<span class="number">0</span>],<span class="number">2</span>,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>)</span><br><span class="line">        self.relu=nn.ReLU(<span class="literal">True</span>)</span><br><span class="line">        self.final = nn.Conv2d(<span class="number">2</span>, num_classes, <span class="number">1</span>)</span><br><span class="line">        self.maxp=nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">        self.finalsof=nn.Softmax(dim=-<span class="number">1</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, inputs</span>):</span></span><br><span class="line">        feate1=self.Down1(inputs)</span><br><span class="line">        feate11=self.maxp(feate1)</span><br><span class="line">        e1 = self.encoder1(feate11)<span class="comment">#64,512,512</span></span><br><span class="line">        e11=self.encodecov1(e1)</span><br><span class="line">        e2 = self.encoder2(e1)<span class="comment">#128,256,256</span></span><br><span class="line">        e21=self.encodecov2(e2)</span><br><span class="line">        e3 = self.encoder3(e2)<span class="comment">#256，128，128</span></span><br><span class="line">        e31=self.encodecov3(e3)</span><br><span class="line">        e4 = self.encoder4(e3)<span class="comment">#512，64，64</span></span><br><span class="line">        feate5=self.Down5(e4)</span><br><span class="line">        Up6=self.Up1(e31,feate5)</span><br><span class="line">        Up7=self.Up2(e21,Up6)</span><br><span class="line">        Up8=self.Up3(e11,Up7)</span><br><span class="line">        Up9=self.Up4(feate1,Up8)</span><br><span class="line">        final=self.cov111(Up9)</span><br><span class="line">        final=self.relu(final)</span><br><span class="line">        final=self.final(final)</span><br><span class="line">        <span class="keyword">return</span> final</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize_weights</span>(<span class="params">self, *stages</span>):</span></span><br><span class="line">        <span class="keyword">for</span> modules <span class="keyword">in</span> stages:</span><br><span class="line">            <span class="keyword">for</span> module <span class="keyword">in</span> modules.modules():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Conv2d):</span><br><span class="line">                    nn.init.kaiming_normal_(module.weight)</span><br><span class="line">                    <span class="keyword">if</span> module.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        module.bias.data.zero_()</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d):</span><br><span class="line">                    module.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                    module.bias.data.zero_()</span><br></pre></td></tr></table></figure> #### Dilated convolution It refers to the
injection of uncomputed voids into the standard convolution kernel, as
shown in the figure, and in this way increases the perceptual wildness
of the network <img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/空洞卷积.4f4nh152m4c0.webp"
alt="Dilated convolution" /></p>
<h4 id="res-block">Res-Block</h4>
<p><img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/残差学习单元.78s2ei4w2200.webp"
alt="Res-Block" /> This structure does not complicate the computation
during training and no other parameters are generated to consume memory.
And it can also help to retain both low-dimensional and high-latitude
features of the feature map.</p>
<h3 id="loss-function">loss function</h3>
<p>In this projcet, a combined loss function combining a pixel-based
cross-entropy loss function and a Disce loss function is used as the
overall training loss function. The combination of the two loss
functions allows the simultaneous acquisition of CE-loss capable of
pixel-based computation, while using Dice loss to balance the
disadvantage of unreliable CE-loss performance when the ratio of water
to non-water bodies in the image is out of balance.</p>
<h4 id="ce-loss">CE-loss</h4>
<p>The cross-entropy loss function is by far the most commonly used loss
function for image semantic segmentation tasks. This method examines
each pixel point individually and compares the class predictions with
the one-hot encoded label. The equation implemented is as follows <span
class="math display">\[
\operatorname{loss}=\sum_{j} t_{i, j} \log \left(y_{i,
j}\right)+\left(1-t_{i, j}\right) \log \left(1-y_{i, j}\right)
\]</span></p>
<h4 id="dice-loss">Dice loss</h4>
<p>The formula is implemented as follows, in effect finding the overlap
between the two samples <span class="math display">\[
\operatorname{loss}=1-\frac{2|A \cap B|}{|A|+|B|}
\]</span></p>
<hr />
<h2 id="result">Result</h2>
<h3 id="accuracy-evaluation">Accuracy Evaluation</h3>
<p>The main accuracy evaluation methods used in this paper are F-score,
kappa coefficient, and MIoU coefficient.</p>
<h4 id="f-score">F-score</h4>
<p><span class="math display">\[
F-\text { score }=\frac{\left(1+\beta^{2}\right) \text { precision }
\times \text { recall }}{\beta^{2} \text { precision }+\text { recall }}
\]</span> <span class="math display">\[
\begin{array}{r}
\text { precision }=\frac{T P}{T P+F P} \\
\text { recall }=\frac{T P}{T P+F N}
\end{array}
\]</span></p>
<h4 id="kappa-coefficient">Kappa coefficient</h4>
<p><span class="math display">\[
K=\frac{N \sum_{i=1}^{r} x_{i i}-\sum_{i=1}^{r}\left(x_{i+} \times
x_{+i}\right)}{N^{2}-\sum_{i=1}^{r}\left(x_{i+} \times x_{+i}\right)}
\]</span></p>
<h4 id="mathrmmlou-coefficient"><span
class="math inline">\(\mathrm{MlOU}\)</span> coefficient</h4>
<p><span class="math display">\[
\mathrm{MlOU}=\frac{1}{k+1} \sum_{i=0}^{k} \frac{p_{i i}}{\sum_{j=0}^{k}
p_{i j}+\sum_{i=0}^{k} p_{j i}-p_{i i}}
\]</span> Equal <span class="math display">\[
\mathrm{MlOU}=\frac{1}{k+1} \sum_{i=0}^{k} \frac{T P}{F N+F P+T P}
\]</span></p>
<h3 id="result-1">Result</h3>
<table>
<thead>
<tr class="header">
<th>Network Structure</th>
<th>F-SCORE</th>
<th>KAPPA</th>
<th>MIOU</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DEEPLABV3+</td>
<td>0.901</td>
<td>0.812</td>
<td>93.85%</td>
</tr>
<tr class="even">
<td>UNET</td>
<td>0.966</td>
<td>0.899</td>
<td>96.58%</td>
</tr>
<tr class="odd">
<td>DLINKNET</td>
<td>0.911</td>
<td>0.794</td>
<td>93.32%</td>
</tr>
<tr class="even">
<td>RES-UNET</td>
<td>0.939</td>
<td>0.968</td>
<td>98.85%</td>
</tr>
</tbody>
</table>
<p><img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.6se9mi0v9po0.webp"
alt="result" /> This picture shows the effect of each network structures
in extracting water bodies from remote sensing images.</p>
<p>Through these data we can see the ResUnet structure provided in this
paper had the highest MIoU at 98.85% and the highest Kappa index at
0.968. This indicates that the ResUnet model was able to extract the
vast majority of the water bodies and also had the highest accuracy.</p>
<h2 id="finally">Finally</h2>
<p><img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.18ita2kmqcu8.webp"
alt="image" /> Use this algorithm to extract water body from the
93696*62464 remote sensing image of Chengdu China. <img
src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/image.3tbljosiyhi0.webp"
alt="image" /> This took only about 10 minutes.</p>
<p>More detail about the codes of this project you can check from my <a
target="_blank" rel="noopener" href="https://github.com/waterkingest/pytorch_form">GitHub</a>.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Yuhang Chen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://waterkingest.gitee.io/2022/03/26/water-extract/">http://waterkingest.gitee.io/2022/03/26/water-extract/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Study/">Study</a><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Pytorch/">Pytorch</a><a class="post-meta__tags" href="/tags/AI/">AI</a><a class="post-meta__tags" href="/tags/CV/">CV</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/20220326/pytorch.5sb4sp2wouc0.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/WeChanSQ.png" target="_blank"><img class="post-qr-code-img" src="/img/WeChanSQ.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/AliPayQR.png" target="_blank"><img class="post-qr-code-img" src="/img/AliPayQR.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/26/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BEapi%E7%88%AC%E8%99%AB/"><img class="prev-cover" src="https://t11.baidu.com/it/u=777242464,306041244&amp;fm=173&amp;app=25&amp;f=JPEG?w=640&amp;h=320&amp;s=DCC9C20B1A2008909605ECDC0100C0B3" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">百度地图api爬虫</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/24/%E5%A0%86%E6%8E%92%E5%BA%8F/"><img class="next-cover" src="/img/favicon.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">堆排序</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/03/21/words-memory/" title="背单词小脚本"><img class="cover" src="/img/favicon.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-21</div><div class="title">背单词小脚本</div></div></a></div><div><a href="/2022/03/22/Selenium/" title="Selenium使用手册"><img class="cover" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fbkimg.cdn.bcebos.com%2Fpic%2F279759ee3d6d55fb3cfdd81761224f4a20a4ddcc&refer=http%3A%2F%2Fbkimg.cdn.bcebos.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1650506145&t=31abef05e1dc237fda46baf33bbadf6b" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-22</div><div class="title">Selenium使用手册</div></div></a></div><div><a href="/2022/03/23/pandas/" title="Pandas用法（一）"><img class="cover" src="https://www.runoob.com/wp-content/uploads/2021/04/pandas.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-23</div><div class="title">Pandas用法（一）</div></div></a></div><div><a href="/2022/03/23/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" title="快速排序"><img class="cover" src="/img/favicon.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-23</div><div class="title">快速排序</div></div></a></div><div><a href="/2022/03/23/pandas2/" title="Pandas用法（二）"><img class="cover" src="https://www.runoob.com/wp-content/uploads/2021/04/pandas.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-23</div><div class="title">Pandas用法（二）</div></div></a></div><div><a href="/2022/03/24/%E5%A0%86%E6%8E%92%E5%BA%8F/" title="堆排序"><img class="cover" src="/img/favicon.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-24</div><div class="title">堆排序</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Yuhang Chen</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">28</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/waterkingest"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/waterkingest" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:waterkingest@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=727466381&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#target"><span class="toc-number">1.</span> <span class="toc-text">Target</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#method"><span class="toc-number">2.</span> <span class="toc-text">Method</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#data-processing"><span class="toc-number">2.1.</span> <span class="toc-text">Data processing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#network-structure"><span class="toc-number">2.2.</span> <span class="toc-text">Network structure</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#res-block"><span class="toc-number">2.2.1.</span> <span class="toc-text">Res-Block</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loss-function"><span class="toc-number">2.3.</span> <span class="toc-text">loss function</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ce-loss"><span class="toc-number">2.3.1.</span> <span class="toc-text">CE-loss</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dice-loss"><span class="toc-number">2.3.2.</span> <span class="toc-text">Dice loss</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#result"><span class="toc-number">3.</span> <span class="toc-text">Result</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#accuracy-evaluation"><span class="toc-number">3.1.</span> <span class="toc-text">Accuracy Evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#f-score"><span class="toc-number">3.1.1.</span> <span class="toc-text">F-score</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kappa-coefficient"><span class="toc-number">3.1.2.</span> <span class="toc-text">Kappa coefficient</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mathrmmlou-coefficient"><span class="toc-number">3.1.3.</span> <span class="toc-text">\(\mathrm{MlOU}\) coefficient</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#result-1"><span class="toc-number">3.2.</span> <span class="toc-text">Result</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finally"><span class="toc-number">4.</span> <span class="toc-text">Finally</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/24/Linear-Algebra/" title="Linear_Algebra"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linear_Algebra"/></a><div class="content"><a class="title" href="/2023/08/24/Linear-Algebra/" title="Linear_Algebra">Linear_Algebra</a><time datetime="2023-08-24T15:44:13.000Z" title="Created 2023-08-24 11:44:13">2023-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/01/linear-System/" title="linear System"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="linear System"/></a><div class="content"><a class="title" href="/2023/07/01/linear-System/" title="linear System">linear System</a><time datetime="2023-07-01T14:08:16.000Z" title="Created 2023-07-01 10:08:16">2023-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/23/Pygame-1/" title="Pygame(1)"><img src="https://www.pygame.org/ftp/pygame-head-party.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Pygame(1)"/></a><div class="content"><a class="title" href="/2022/12/23/Pygame-1/" title="Pygame(1)">Pygame(1)</a><time datetime="2022-12-23T14:45:20.000Z" title="Created 2022-12-23 09:45:20">2022-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/25/shenzhen/" title="鹏城历险记"><img src="https://cdn.jsdelivr.net/gh/waterkingest/image_bed@master/20220611/58163e0ffc6b515414fd79959bd5abdd.v398ldcf30g.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="鹏城历险记"/></a><div class="content"><a class="title" href="/2022/05/25/shenzhen/" title="鹏城历险记">鹏城历险记</a><time datetime="2022-05-25T19:21:59.000Z" title="Created 2022-05-25 15:21:59">2022-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/03/Machine-learning-%E6%95%B0%E5%AD%A6%E7%9B%B8%E5%85%B3%EF%BC%882%EF%BC%89/" title="Machine learning--数学相关（2）"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Machine learning--数学相关（2）"/></a><div class="content"><a class="title" href="/2022/05/03/Machine-learning-%E6%95%B0%E5%AD%A6%E7%9B%B8%E5%85%B3%EF%BC%882%EF%BC%89/" title="Machine learning--数学相关（2）">Machine learning--数学相关（2）</a><time datetime="2022-05-03T14:08:02.000Z" title="Created 2022-05-03 10:08:02">2022-05-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By Yuhang Chen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a rel="nofollow noopener"><span>YH </span></a><i class="iconfont icon-heart"></i><a rel="nofollow noopener"><span> GC</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'IwM9Wemmu4uk5ntEPJfWrdpr-gzGzoHsz',
      appKey: 'JfMdF85ef98TICFdMwWhbc3m',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="7422861869" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"></div><script type="text/javascript">ap.play()</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,0" opacity="0.9" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="music"]):not([href="secret"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>